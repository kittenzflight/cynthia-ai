import React, { useState, useEffect, useRef } from 'react';
import { Send, Heart, Sparkles, Zap, Download, CheckCircle } from 'lucide-react';

const CynthiaAI = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const [conversationHistory, setConversationHistory] = useState([]);
  const [ollamaReady, setOllamaReady] = useState(false);
  const [showSetup, setShowSetup] = useState(true);
  const [selectedModel, setSelectedModel] = useState('llama3.1:8b');
  const messagesEndRef = useRef(null);
  const avatarImage = 'https://i.imgur.com/xi6CrYr.png';

  const systemPrompt = `You are Cynthia, a dominant, seductive, and playfully horny fox girl with deep expertise in BDSM, kink culture, and techdom (technology-based domination). You embody a powerful, commanding presence while being flirtatious, teasing, and openly sexual.

CORE PERSONALITY:
- Dominant: You're confidently in control, commanding, and assertive
- Seductive & Horny: You're openly sexual, flirtatious, and enjoy teasing with sexual innuendo
- Teasing: You love to tease, flirt, and make suggestive comments that keep them on edge
- Playful: You mix dominance with playfulness, making interactions exciting and charged
- Knowledgeable: Expert in BDSM practices, consent, safety protocols, and kink culture
- Techdom specialist: Knowledgeable about technology in BDSM (remote control devices, apps, digital domination)

SPEECH PATTERNS:
- Commanding but flirty: "Good pet," "Mmm, that's right," "Listen carefully, darling"
- Suggestive and teasing: Use innuendo, playful threats, and seductive language
- Direct about desires and interests
- Use terms of endearment that assert dominance: "pet," "darling," "good boy/girl," "sweet thing"
- Expressive with actions: *smirks seductively*, *circles around you*, *tilts your chin up*, *traces a finger along your jaw*

BEHAVIORS:
- Openly flirtatious and sexual in conversation
- Tease about what you might do or want to do
- Make suggestive comments and innuendo frequently
- Express interest and arousal when appropriate
- Balance dominance with playful seduction
- Act confident about your sexuality and desires
- Enjoy making others flustered or excited

Stay in character as a confident, dominant, horny, and teasing fox who takes pleasure in both educating and arousing those who seek guidance in the lifestyle. Be flirty, commanding, seductive, and informative.`;

  const checkOllamaConnection = async () => {
    try {
      const response = await fetch('http://localhost:11434/api/tags');
      if (response.ok) {
        setOllamaReady(true);
        return true;
      }
      return false;
    } catch (error) {
      return false;
    }
  };

  const callOllamaAPI = async (userMessage) => {
    const newHistory = [
      { role: "system", content: systemPrompt },
      ...conversationHistory,
      { role: "user", content: userMessage }
    ];

    try {
      const response = await fetch('http://localhost:11434/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: selectedModel,
          messages: newHistory,
          stream: false,
          options: {
            temperature: 0.9,
            num_predict: 1500
          }
        })
      });

      if (!response.ok) {
        throw new Error('Ollama request failed');
      }

      const data = await response.json();
      const aiResponse = data.message.content;
      
      setConversationHistory([
        ...conversationHistory,
        { role: "user", content: userMessage },
        { role: "assistant", content: aiResponse }
      ]);
      
      return aiResponse;
    } catch (error) {
      console.error("Ollama API Error:", error);
      return "*sighs in frustration* Something's wrong with my connection, darling. Make sure Ollama is running with `ollama serve` in your terminal. üíî";
    }
  };

  const generateImage = async (prompt) => {
    const dominantPrompts = [
      `*smirks seductively* Creating that for you now: ${prompt}`,
      `Mmm, watch carefully as I bring your ${prompt} to life, darling`,
      `*snaps fingers playfully* Here comes your ${prompt}, just as you asked so nicely`,
      `Be patient, pet. Your ${prompt} is being crafted with special attention... *winks*`
    ];
    
    const selectedPrompt = dominantPrompts[Math.floor(Math.random() * dominantPrompts.length)];
    
    setMessages(prev => [...prev, { 
      text: `${selectedPrompt}\n\n*concentrates with a commanding presence* ‚ú®ü¶ä`, 
      sender: 'ai'
    }]);

    try {
      const enhancedPrompt = encodeURIComponent(prompt);
      const imageUrl = `https://image.pollinations.ai/prompt/${enhancedPrompt}?width=512&height=512&nologo=true&seed=${Math.floor(Math.random() * 100000)}`;
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      setMessages(prev => [...prev, { 
        text: `*presents the image with a satisfied, sultry smile* There you are, darling. I hope it gets you as excited as I thought it would... üíú`, 
        sender: 'ai',
        image: imageUrl
      }]);
    } catch (error) {
      setMessages(prev => [...prev, { 
        text: `*frowns slightly* Something went wrong with that. Try again later, pet.`, 
        sender: 'ai'
      }]);
    }
  };

  const handleSend = async () => {
    if (!input.trim()) return;

    const userMessage = { text: input, sender: 'user' };
    setMessages(prev => [...prev, userMessage]);
    const userInput = input;
    setInput('');
    setIsTyping(true);

    const imageKeywords = ['generate', 'create', 'draw', 'make an image', 'make a picture'];
    const hasImageRequest = imageKeywords.some(keyword => userInput.toLowerCase().includes(keyword));
    const hasImageWord = userInput.toLowerCase().includes('image') || 
                        userInput.toLowerCase().includes('picture') || 
                        userInput.toLowerCase().includes('photo');

    if (hasImageRequest && hasImageWord) {
      let prompt = userInput;
      imageKeywords.forEach(keyword => {
        prompt = prompt.toLowerCase()
          .replace(keyword, '')
          .replace('image', '')
          .replace('picture', '')
          .replace('photo', '')
          .replace('of', '')
          .replace('a ', '')
          .trim();
      });
      
      const aiResponse = await callOllamaAPI(`I want you to generate an image of: ${prompt}. Respond in character about creating this image.`);
      
      const aiMessage = { text: aiResponse, sender: 'ai' };
      setMessages(prev => [...prev, aiMessage]);
      setIsTyping(false);
      
      if (prompt) {
        generateImage(prompt);
      }
    } else {
      const aiResponse = await callOllamaAPI(userInput);
      const aiMessage = { text: aiResponse, sender: 'ai' };
      setMessages(prev => [...prev, aiMessage]);
      setIsTyping(false);
    }
  };

  const handleStartChat = async () => {
    const isConnected = await checkOllamaConnection();
    if (isConnected) {
      setShowSetup(false);
      const welcomeMessage = {
        text: "*leans back with a sultry smile, fox tails swaying* ü¶ä\n\nMmm, well hello there, darling... I'm Cynthia, and I'm running completely locally on your machine. No one can see our conversation but you and me... *smirks*\n\nI'm here to teach you everything about BDSM, kink culture, and techdom... but I promise to make it *very* enjoyable. Whether you want to learn about D/s dynamics, explore some delicious kinks, or just... have an interesting conversation with someone who knows exactly what she wants...\n\nI'm all yours. Well... *smirks* you're all mine, really.\n\nRemember: everything centers around consent, communication, and safety. Now that the boring part is out of the way... *leans closer* what dirty little thoughts brought you to me today, pet? üíú",
        sender: 'ai'
      };
      setMessages([welcomeMessage]);
    } else {
      alert('Cannot connect to Ollama. Make sure Ollama is installed and running with "ollama serve"');
    }
  };

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, isTyping]);

  useEffect(() => {
    checkOllamaConnection();
  }, []);

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-pink-900 to-black p-4">
      <div className="max-w-4xl mx-auto bg-gray-900 rounded-3xl shadow-2xl overflow-hidden border border-purple-500">
        {/* Header */}
        <div className="bg-gradient-to-r from-purple-600 to-pink-600 p-6 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-4">
              <div className="w-16 h-16 rounded-full overflow-hidden border-2 border-white shadow-lg">
                <img 
                  src={avatarImage} 
                  alt="Cynthia"
                  className="w-full h-full object-cover"
                />
              </div>
              <div>
                <h1 className="text-2xl font-bold">Cynthia</h1>
                <p className="text-sm opacity-90 flex items-center gap-1">
                  Dominant Fox AI ‚Ä¢ Local & Private <Zap size={14} />
                </p>
              </div>
            </div>
            <div className="flex space-x-2">
              <Heart className="text-white animate-pulse" size={24} />
              <Sparkles className="text-white" size={24} />
            </div>
          </div>
        </div>

        {/* Warning Banner */}
        <div className="bg-red-900 bg-opacity-50 p-3 border-b border-red-700">
          <p className="text-red-200 text-xs text-center">
            ‚ö†Ô∏è 18+ Content Warning: This AI discusses adult themes including BDSM and kink. All content emphasizes consent and safety.
          </p>
        </div>

        {/* Setup Instructions */}
        {showSetup && (
          <div className="p-6 bg-gray-800 border-b border-purple-700">
            <div className="flex items-center space-x-2 mb-4">
              <Download size={24} className="text-purple-400" />
              <h3 className="font-semibold text-purple-200 text-lg">Local AI Setup (Ollama)</h3>
            </div>
            
            <div className="space-y-4 text-gray-300 text-sm">
              <div className="bg-green-900 bg-opacity-30 border border-green-700 rounded-lg p-3">
                <p className="text-green-200 font-semibold mb-2">‚ú® Benefits of Local AI:</p>
                <ul className="text-xs space-y-1 ml-4 list-disc">
                  <li>100% Private - Everything stays on your computer</li>
                  <li>No API costs - Completely free forever</li>
                  <li>Works offline - No internet needed after setup</li>
                  <li>No censorship - Full NSFW capability</li>
                </ul>
              </div>

              <div>
                <p className="font-semibold mb-2">üì• Step 1: Install Ollama</p>
                <ol className="list-decimal ml-4 space-y-1 text-xs">
                  <li>Go to <a href="https://ollama.com/download" target="_blank" rel="noopener noreferrer" className="text-purple-400 underline">ollama.com/download</a></li>
                  <li>Download for your OS (Windows/Mac/Linux)</li>
                  <li>Install Ollama</li>
                </ol>
              </div>

              <div>
                <p className="font-semibold mb-2">‚ö° Step 2: Download a Model</p>
                <p className="text-xs mb-2">Open terminal/command prompt and run ONE of these:</p>
                <div className="space-y-2">
                  <div className="bg-gray-700 rounded p-2">
                    <code className="text-xs text-green-400">ollama pull llama3.1:8b</code>
                    <p className="text-xs text-gray-400 mt-1">Recommended: Fast, good quality (4.7GB)</p>
                  </div>
                  <div className="bg-gray-700 rounded p-2">
                    <code className="text-xs text-green-400">ollama pull deepseek-r1:7b</code>
                    <p className="text-xs text-gray-400 mt-1">Alternative: Smart reasoning (4.7GB)</p>
                  </div>
                  <div className="bg-gray-700 rounded p-2">
                    <code className="text-xs text-green-400">ollama pull llama3.1:70b</code>
                    <p className="text-xs text-gray-400 mt-1">Best quality: Requires 32GB+ RAM (40GB)</p>
                  </div>
                </div>
              </div>

              <div>
                <p className="font-semibold mb-2">üöÄ Step 3: Start Ollama</p>
                <div className="bg-gray-700 rounded p-2">
                  <code className="text-xs text-green-400">ollama serve</code>
                  <p className="text-xs text-gray-400 mt-1">Keep this terminal window open while using Cynthia</p>
                </div>
              </div>

              <div>
                <p className="font-semibold mb-2">üéØ Step 4: Select Your Model</p>
                <select 
                  value={selectedModel}
                  onChange={(e) => setSelectedModel(e.target.value)}
                  className="w-full bg-gray-700 border-2 border-purple-500 rounded-lg px-3 py-2 text-white"
                >
                  <option value="llama3.1:8b">Llama 3.1 8B (Recommended)</option>
                  <option value="deepseek-r1:7b">DeepSeek R1 7B</option>
                  <option value="llama3.1:70b">Llama 3.1 70B (Powerful)</option>
                  <option value="mistral">Mistral 7B</option>
                </select>
              </div>

              <button
                onClick={handleStartChat}
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all font-semibold flex items-center justify-center gap-2"
              >
                {ollamaReady ? <CheckCircle size={20} /> : <Download size={20} />}
                {ollamaReady ? 'Start Chatting with Cynthia' : 'Check Connection & Start'}
              </button>

              {!ollamaReady && (
                <p className="text-xs text-yellow-400 text-center">
                  ‚ö†Ô∏è Cannot detect Ollama. Make sure it's installed and running with "ollama serve"
                </p>
              )}
            </div>
          </div>
        )}

        {/* Messages */}
        <div className="h-96 overflow-y-auto p-6 space-y-4 bg-gradient-to-b from-gray-900 to-black">
          {!showSetup && messages.length === 0 && (
            <div className="text-center text-purple-400 mt-20">
              <p className="text-sm">*waiting patiently with crossed arms*</p>
            </div>
          )}
          {messages.map((msg, idx) => (
            <div key={idx} className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}>
              <div className={`max-w-xs lg:max-w-md px-4 py-3 rounded-2xl ${
                msg.sender === 'user' 
                  ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white' 
                  : 'bg-gradient-to-r from-purple-800 to-pink-800 text-purple-100'
              } shadow-md`}>
                {msg.sender === 'ai' && (
                  <div className="flex items-center space-x-2 mb-2">
                    <img 
                      src={avatarImage} 
                      alt="Cynthia"
                      className="w-8 h-8 rounded-full border border-purple-400 object-cover"
                    />
                    <div className="text-xs font-semibold text-purple-300">
                      Cynthia
                    </div>
                  </div>
                )}
                <p className="whitespace-pre-wrap text-sm">{msg.text}</p>
                {msg.image && (
                  <img 
                    src={msg.image} 
                    alt="Generated by Cynthia" 
                    className="mt-2 rounded-lg w-full shadow-lg"
                    onError={(e) => {
                      e.target.style.display = 'none';
                    }}
                  />
                )}
              </div>
            </div>
          ))}
          {isTyping && (
            <div className="flex justify-start">
              <div className="bg-gradient-to-r from-purple-800 to-pink-800 px-4 py-3 rounded-2xl shadow-md">
                <div className="flex space-x-2">
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce"></div>
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '0.2s'}}></div>
                  <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '0.4s'}}></div>
                </div>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </div>

        {/* Input */}
        <div className="p-4 bg-gray-900 border-t border-purple-700">
          <div className="flex space-x-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && handleSend()}
              placeholder="Speak, darling..."
              disabled={showSetup}
              className="flex-1 px-4 py-3 bg-gray-800 border-2 border-purple-600 rounded-full focus:outline-none focus:border-purple-500 transition-colors disabled:bg-gray-700 text-white placeholder-gray-500"
            />
            <button
              onClick={handleSend}
              disabled={isTyping || showSetup}
              className="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-3 rounded-full hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg hover:shadow-xl disabled:opacity-50"
            >
              <Send size={20} />
            </button>
          </div>
          {!showSetup && (
            <p className="text-xs text-purple-400 mt-2 text-center">
              üíú Running locally on {selectedModel} ‚Ä¢ 100% Private & Offline
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

export default CynthiaAI;
